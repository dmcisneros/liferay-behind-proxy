# Block 1: Redirects HTTP (Port 80) to HTTPS (Port 443)
server {
    listen 80;
    server_name dominio.ejemplo.com;
    return 301 https://$host$request_uri; # Permanent redirection to HTTPS
}

# Block 2: Reverse Proxy Configuration with SSL/TLS (Port 443)
server {
    listen 443 ssl; # Listen on port 443 with SSL enabled
    server_name dominio.ejemplo.com;

    # Paths to the certificates (mounted as a volume)
    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;

    # Recommended SSL security configurations
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        # Sends the request to the 'liferay' service on port 8080 (backend)
        proxy_pass http://liferay:8080;
        
        # --- Forwarding Headers (Essential for Liferay) ---

        # Indicates the original host requested by the client
        proxy_set_header X-Forwarded-Host $host;
        
        # Indicates the original port (now 443)
        proxy_set_header X-Forwarded-Port 443;
        
        # *** KEY: Indicates the original protocol is HTTPS ***
        proxy_set_header X-Forwarded-Proto https; 
        
        # Standard Headers
        proxy_set_header Host $http_host;         # Passes the original Host header
        proxy_set_header X-Real-IP $remote_addr;  # Passes the real client IP
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # Passes the chain of proxies
        
        # Recommended proxy configurations
        proxy_redirect off;
        proxy_connect_timeout 240;
        proxy_send_timeout 240;
        proxy_read_timeout 240;
    }
}